name: atlas

on:
  schedule:
    - cron: "45 */2 * * *"  # 每分钟运行一次
  workflow_dispatch:  # 手动触发即可

jobs:
  probe_loop:
    runs-on: ubuntu-latest
    steps:
      - name: Loop probe
        run: |
          while true; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://xui.pusytroller.cf)
            echo "$(date): Status=$STATUS"
            
            if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
              echo "Trigger target workflow..."
              curl -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                https://api.github.com/repos/workspace/actions/workflows/pan.yml/dispatches \
                -d '{"ref":"main"}'
            fi

            sleep 10  # 每 10 秒检测一次，可按需调整
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
